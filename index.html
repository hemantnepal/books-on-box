<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Books on Box</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f0fdf4;
      color: #333;
    }
    header {
      background-color: #2f855a;
      color: white;
      padding: 1rem;
      text-align: center;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    main {
      padding: 2rem;
      max-width: 600px;
      margin: auto;
    }
    button {
      background-color: #2f855a;
      color: white;
      padding: 0.7rem 1.2rem;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 1rem;
    }
    button:hover {
      background-color: #276749;
    }
    input[type="text"], select {
      padding: 0.6rem;
      width: calc(100% - 1rem);
      margin-top: 0.5rem;
      margin-bottom: 1rem;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    .scanner-section {
      margin-top: 2rem;
      padding: 1rem;
      background: #ffffff;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    video {
      width: 100%;
      height: auto;
      border-radius: 5px;
      margin-top: 1rem;
    }
    @media (max-width: 600px) {
      main {
        padding: 1rem;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Books on Box</h1>
    <p>Welcome to Books on Box â€“ Explore. Borrow. Read.</p>
  </header>

  <main>
    <section class="scanner-section">
      <h2>Scan Barcode</h2>
      <p>Select Mode:</p>
      <select id="mode">
        <option value="borrow">Borrow</option>
        <option value="return">Return</option>
      </select>
      <p>Scan User ID and then Book Code below:</p>
      <video id="preview"></video>
      <button onclick="startScanner()">Start Scanning</button>
      <p id="scannedResult"></p>
    </section>
  </main>

  <script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
  <script>
    let scanner;
    let scannedUser = null;
    let scannedBook = null;

    async function startScanner() {
      const resultElem = document.getElementById('scannedResult');
      const mode = document.getElementById('mode').value;
      resultElem.innerText = "Scanning...";

      scanner = new Html5Qrcode("preview");
      const config = { fps: 10, qrbox: 250 };

      scanner.start(
        { facingMode: "environment" },
        config,
        async qrCodeMessage => {
          if (!scannedUser) {
            scannedUser = qrCodeMessage;
            resultElem.innerText = `User ID: ${scannedUser} scanned. Now scan Book Code.`;
          } else if (!scannedBook) {
            scannedBook = qrCodeMessage;
            resultElem.innerText = `Book ID: ${scannedBook} scanned. Sending to server...`;

            // Send data to Google Apps Script endpoint
            const response = await fetch("https://script.google.com/u/0/home/projects/1eKLLZLPGEv4hyk2ROHmqHhYXXnrBV1zSaE30KeYMBWOUlddsb9Z_63c3/edit", {
              method: "POST",
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                user_id: scannedUser,
                book_id: scannedBook,
                action: mode
              })
            });
            const result = await response.text();
            resultElem.innerText = result;
            scanner.stop();
            scannedUser = null;
            scannedBook = null;
          }
        },
        errorMessage => {
          // Handle error
        }
      ).catch(err => {
        resultElem.innerText = `Camera error: ${err}`;
      });
    }
  </script>
</body>
</html>
