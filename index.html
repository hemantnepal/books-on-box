<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Books on Box</title>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f0fdf4;
      color: #333;
    }
    header {
      background-color: #2f855a;
      color: white;
      padding: 1rem;
      text-align: center;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    main {
      padding: 2rem;
      max-width: 600px;
      margin: auto;
    }
    button {
      background-color: #2f855a;
      color: white;
      padding: 0.7rem 1.2rem;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      margin-top: 1rem;
      margin-right: 0.5rem;
    }
    button:hover {
      background-color: #276749;
    }
    .scanner-section {
      margin-top: 2rem;
      padding: 1rem;
      background: #ffffff;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }
    #preview {
      width: 100%;
      height: 300px;
      border-radius: 5px;
      margin-top: 1rem;
    }
    .toggle {
      display: flex;
      justify-content: center;
      margin-top: 1rem;
    }
    @media (max-width: 600px) {
      main {
        padding: 1rem;
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Books on Box</h1>
    <p>Welcome to Books on Box â€“ Explore. Borrow. Read.</p>
  </header>

  <main>
    <section class="scanner-section">
      <h2>Scan Barcode</h2>
      <p>Scan User ID or Book Code below:</p>
      <div class="toggle">
        <button onclick="setMode('borrow')">Borrow</button>
        <button onclick="setMode('return')">Return</button>
      </div>
      <p>Mode: <span id="modeDisplay">borrow</span></p>
      <div id="preview"></div>
      <button onclick="startScanner()">Start Scanning</button>
      <p id="scannedResult"></p>
    </section>
  </main>

  <script src="https://unpkg.com/html5-qrcode@2.3.8/minified/html5-qrcode.min.js"></script>
  <script>
    let scanner;
    let mode = 'borrow';
    let scannedUser = null;
    let scannedBook = null;

    function setMode(selectedMode) {
      mode = selectedMode;
      document.getElementById('modeDisplay').textContent = selectedMode;
    }

    function startScanner() {
      const resultElem = document.getElementById('scannedResult');
      resultElem.innerText = "Requesting camera...";

      scanner = new Html5Qrcode("preview");
      const config = { fps: 10, qrbox: 250 };

      scanner.start(
        { facingMode: "environment" },
        config,
        qrCodeMessage => {
          if (!scannedUser) {
            scannedUser = qrCodeMessage;
            resultElem.innerText = `User ID: ${qrCodeMessage} scanned. Now scan Book.`;
          } else {
            scannedBook = qrCodeMessage;
            resultElem.innerText = `Book ID: ${qrCodeMessage} scanned. Processing...`;
            scanner.stop();
            sendToGoogleAppsScript(scannedUser, scannedBook, mode);
          }
        },
        errorMessage => {
          // Optionally handle scan errors
        }
      ).catch(err => {
        resultElem.innerText = `Camera error: ${err}`;
      });
    }

    function sendToGoogleAppsScript(userId, bookId, mode) {
      const resultElem = document.getElementById('scannedResult');
      const url = `https://script.google.com/macros/s/1eKLLZLPGEv4hyk2ROHmqHhYXXnrBV1zSaE30KeYMBWOUlddsb9Z_63c3/exec?user=${userId}&book=${bookId}&mode=${mode}`;
      fetch(url)
        .then(response => response.text())
        .then(data => {
          resultElem.innerText = `Server response: ${data}`;
          scannedUser = null;
          scannedBook = null;
        })
        .catch(err => {
          resultElem.innerText = `Error sending data: ${err}`;
        });
    }
  </script>
</body>
</html>
